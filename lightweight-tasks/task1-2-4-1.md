---
title: 阶段3 后续差异化收敛 TODO
status: [x]
progress:
- 2025-10-30 04:20:00: 记录 PR 审核建议未完成项，准备拆分后续任务。
- 2025-10-30 05:15:30: 完成控制请求委派重构并补充会话单测验证。
- 2025-10-30 05:16:45: 整合 stream-json I/O 工具并新增输入单测确认行为。
---

## PR 审核建

@openspec/lightweight-tasks/pr-comment.md

## 待办事项

1. [x] 拆分控制请求路由至 `StreamJsonController`
   - 目标：将 `packages/cli/src/streamJson/session.ts` 中的控制请求处理（`initialize`、`interrupt` 等）迁移到 `controller.ts`，避免重复实现。
   - 动作：
     1. 先在 `packages/cli/src/streamJson/session.test.ts`（若缺失则新建）编写失败用例，校验控制请求由 controller 统一处理。
     2. 调整实现，将控制分支迁移至 `controller.ts`，`session.ts` 仅负责转发。
     3. 补齐与重跑相关测试，确保行为一致。

2. [x] 整合输入/输出职责
   - 目标：消除 `packages/cli/src/streamJson/input.ts` 与 `writer.ts` 间的重复工具函数，将读取与写出整合为统一的 stream I/O 模块。
   - 动作：
     1. 首先在 `packages/cli/src/streamJson` 相关测试中补充/编写失败用例，验证重构后的接口契合预期。
     2. 重构实现，统一输入输出的序列化/反序列化逻辑，理清模块边界。
     3. 更新并通过新增/既有测试，确认整合后的行为正确。
