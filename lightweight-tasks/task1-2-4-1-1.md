---
title: 阶段3-1 stream-json 用户消息去重 TODO
status: [x]
progress:
  - 2025-10-30 06:10:00: 建立去重修复 TODO，登记问题背景与预期。
  - 2025-10-30 13:30:00: 完成 stream-json 用户消息去重修复及单测验证。
---
 
## 背景摘要

- 复现：`--input-format stream-json` 模式下，CLI 会先回显客户端的 `user` 信封，随后 `runNonInteractive` 再次调用 `emitUserMessageFromParts` 输出重复信封。
- 影响：所有流式接入方均会收到重复用户消息，破坏协议对齐与测试断言。
- 根因：`task1-2-4-1` 引入 `userEnvelope` 后缺少条件判定，仍旧无差别地回放用户输入；测试未对该场景覆盖。

## 待办事项（TDD）

1. [x] 修正用户消息回显逻辑（`packages/cli/src/nonInteractiveCli.ts`）  
   - 目标：带 `userEnvelope` 的请求不再重复调用 `emitUserMessageFromParts`，纯文本路径保持原行为。  
   - 动作：
     1. 在 `packages/cli/src/nonInteractiveCli.test.ts` 先编写失败用例，构造 stream-json 输入并断言仅输出一次 `type:"user"` 信封。
     2. 调整实现，引入 `shouldEmitUserEcho`（或等效布尔变量）以区分是否需要回显。
     3. 重新运行新增测试，确认由失败转为通过。

2. [x] 补充覆盖纯文本场景回归（`packages/cli/src/nonInteractiveCli.test.ts`）  
   - 目标：验证无 `userEnvelope` 时依旧会回显一次用户消息，确保旧行为不变。  
   - 动作：
     1. 在同一测试文件添加断言，复用 `writes` 解析逻辑确认纯文本路径 `user` 信封数量仍为 1。
     2. 同步检查相关增量事件、工具结果断言，避免误删。

3. [x] 执行测试与脚本验证  
   - 目标：确保本地回归通过，并在需要时复核示例脚本输出。  
   - 动作：
     1. 跑通 `npm run test -- packages/cli/src/nonInteractiveCli.test.ts` 以及与 stream-json 相关的定向用例。
     2. （可选）运行 `STREAM_JSON_VALIDATE_PROMPT=1 python docs/examples/stream-json/validate_stream_json_cli.py`，确认日志仅出现一次用户回显。

## 验收标准

- stream-json 模式下用户消息只输出一次，无额外回显。
- 新增/既有 stream-json 相关单测全部通过。
- 文档与脚本无需额外调整；如需扩展说明，可单独登记。
